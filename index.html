<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具集</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root{--primary-green:#28a745;--light-green-bg:#e9f5ee;--border-color:#d8e6de;--text-color:#333;--secondary-text-color:#555;--page-bg:#f8f9fa;--animation-speed:0.2s}body{font-family:'Nunito',-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue","PingFang SC","Microsoft YaHei",sans-serif;background-color:var(--page-bg);margin:0;padding:2rem;display:flex;justify-content:center;color:var(--text-color)}.container{display:flex;gap:2rem;width:100%;max-width:1100px}.sidebar{flex:0 0 120px;display:flex;flex-direction:column;align-items:center;gap:1.5rem}.sidebar-item{background-color:#fff;border-radius:1rem;padding:1rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,.05);text-align:center;font-size:.8rem;width:100%;transition:box-shadow var(--animation-speed)}.sidebar-item.active{background:linear-gradient(135deg,#4ad295,#2ab67b);color:#fff;cursor:default}.sidebar-item:not(.active):hover{box-shadow:0 6px 12px rgba(0,0,0,.08)}.sidebar-item.active svg{color:#fff}.content{flex:1;background-color:#fff;border-radius:1rem;padding:2rem;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative;overflow:hidden}.page{position:absolute;top:2rem;left:2rem;right:2rem;bottom:2rem;opacity:0;transition:opacity var(--animation-speed) ease-in-out;pointer-events:none;display:flex;flex-direction:column}.page.active{opacity:1;position:relative;top:auto;left:auto;right:auto;bottom:auto;pointer-events:auto}h1,h2{margin:0 0 .5rem;font-weight:700;flex-shrink:0}h1{font-size:2rem}h2{font-size:1.5rem}.subtitle{margin:0 0 1.5rem;color:var(--secondary-text-color);flex-shrink:0}.update-info{background-color:var(--light-green-bg);border:1px solid var(--border-color);padding:.75rem 1rem;border-radius:.5rem;margin-bottom:1.5rem;font-size:.9rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.update-info .refresh-btn{background-color:var(--primary-green);color:#fff;border:none;padding:.25rem .75rem;border-radius:.25rem;cursor:pointer;font-size:.85rem;font-family:'Nunito',sans-serif;transition:background-color var(--animation-speed)}.update-info .refresh-btn:hover{opacity:.9}.update-info .refresh-btn:disabled{background-color:#999;cursor:not-allowed}.rates-grid-wrapper{overflow-y:auto;flex-grow:1;padding-right:10px;margin-right:-10px}.rates-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}.rate-row{display:flex;align-items:center;background-color:var(--light-green-bg);border-radius:.5rem;padding:.75rem;border:1px solid transparent;transition:transform 0.2s ease-in-out,box-shadow var(--animation-speed) ease,border-color .2s}.rate-row:focus-within{border-color:var(--primary-green)}.rate-row.sortable-ghost{background:#d4f0e2;opacity:.7}.rate-row.sortable-chosen{box-shadow:0 8px 20px rgba(0,0,0,.15);border:1px solid var(--border-color);transform:scale(1.02)}.drag-handle{cursor:grab;color:#b0c9bd;margin-right:.75rem;flex-shrink:0}.drag-handle:active{cursor:grabbing}.currency-code{font-weight:700;width:50px;flex-shrink:0;color:var(--secondary-text-color)}.separator{color:#c9d9d1;margin:0 .5rem}.currency-value{flex-grow:1;border:none;background:transparent;font-size:1rem;font-family:'Menlo','Monaco','Consolas',monospace;padding:.25rem;outline:0;width:100%;cursor:pointer}.currency-name{background-color:#c1e5d4;color:#1a593b;font-weight:500;padding:.25rem .75rem;border-radius:.25rem;font-size:.8rem;white-space:nowrap}.instructions{margin-top:2rem;padding-top:1.5rem;border-top:1px solid #eee;flex-shrink:0}.instructions p{font-size:.9rem;color:var(--secondary-text-color);line-height:1.6}.copy-notification{position:fixed;left:2rem;bottom:2rem;background-color:var(--primary-green);color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;box-shadow:0 4px 10px rgba(0,0,0,.1);font-size:.9rem;z-index:1000;opacity:0;transform:translateX(-120%);transition:opacity var(--animation-speed) ease,transform var(--animation-speed) ease}.copy-notification.show{opacity:1;transform:translateX(0)}.json-container{display:flex;flex-grow:1;gap:.75rem;min-height:0}.json-pane{flex:1;display:flex;flex-direction:column;background-color:var(--light-green-bg);border-radius:.5rem;overflow:hidden}.json-pane textarea,.json-pane pre{width:100%;height:100%;flex-grow:1;padding:.75rem;margin:0;border:none;background:transparent;resize:none;outline:none;font-family:'Menlo','Monaco','Consolas',monospace;font-size:1rem;color:var(--text-color);line-height:1.6;overflow-y:auto}.json-pane pre{white-space:pre-wrap;word-break:break-all}.json-pane pre.error{color:#d9534f;font-weight:700}@media (max-width:900px){.rates-grid{grid-template-columns:1fr}}@media (max-width:768px){body{padding:1rem}.container{flex-direction:column}.content{padding:1rem}.page{top:1rem;left:1rem;right:1rem;bottom:1rem}.sidebar{flex-direction:row;flex:1 1 0%;justify-content:center;gap:1rem;width:100%;max-width:none;margin:0 auto}.sidebar-item{flex:1}.copy-notification{left:1rem;bottom:1rem;width:calc(100% - 2rem);text-align:center}.json-container{flex-direction:column}}
    </style>
</head>
<body>
    <div id="copy-notification" class="copy-notification">已复制</div>
    <div class="container">
        <aside class="sidebar">
            <div id="nav-currency" class="sidebar-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-3.64-2.28m3.64 2.28l-2.28 3.64" /></svg>
                <span>汇率换算</span>
            </div>
            <div id="nav-json" class="sidebar-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg>
                <span>JSON 工具</span>
            </div>
        </aside>
        <main class="content">
            <div id="page-currency" class="page active">
                <h1>汇率换算</h1>
                <p class="subtitle">简单的汇率换算工具，汇率数据定时更新，仅供参考。</p>
                <div class="update-info">
                    <span id="update-time">正在获取汇率数据...</span>
                    <button class="refresh-btn" id="refresh-button">刷新汇率</button>
                </div>
                <div class="rates-grid-wrapper">
                    <div class="rates-grid" id="rates-container"><p>正在加载...</p></div>
                </div>
                <div class="instructions">
                    <h2>汇率工具说明</h2>
                    <p><strong>功能说明:</strong> 使用公开API提供数据，汇率并非毫秒级实时，仅供参考。</p>
                    <p><strong>新手提示:</strong> 您可输入 `100+50` 或 `10*1.1` 等算式后按回车进行计算。点击任意输入框 (数字部分) 可复制当前金额。按住每行最左侧的图标可拖动排序。</p>
                </div>
            </div>
            <div id="page-json" class="page">
                <h1>JSON 格式化</h1>
                <p class="subtitle">粘贴JSON字符串，工具将自动格式化并高亮显示。</p>
                <div class="json-container">
                    <div class="json-pane">
                        <textarea id="json-input" placeholder="在此处粘贴 JSON..."></textarea>
                    </div>
                    <div class="json-pane">
                        <pre id="json-output"></pre>
                    </div>
                </div>
            </div>
        </main>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_CURRENCY = 'CNY';
        const DEFAULT_AMOUNT = 100;
        
        let currencyOrder = [
            'CNY', 'HKD', 'TWD', 'USD', 'RUB', 'VND', 'INR', 'EUR', 'JPY',
            'GBP', 'SGD', 'PHP', 'ARS', 'TRY', 'KRW', 'CHF', 'AUD', 'IDR',
            'THB', 'PKR', 'CAD', 'SAR', 'MXN', 'BDT', 'MYR'
        ];
        const currencyNames = {
            'CNY': '人民币 [中国 ¥]', 'HKD': '港元 [中国香港 HK$]', 'TWD': '台币 [中国台湾 NT$]', 'USD': '美元 [美国 $]', 'RUB': '卢布 [俄罗斯 ₽]', 'VND': '越南盾 [越南 ₫]', 'INR': '卢比 [印度 ₹]', 'EUR': '欧元 [欧盟 €]', 'JPY': '日元 [日本 ¥]', 'GBP': '英镑 [英国 £]', 'SGD': '新元 [新加坡 S$]', 'PHP': '比索 [菲律宾 ₱]', 'ARS': '比索 [阿根廷 $]', 'TRY': '里拉 [土耳其 ₺]', 'KRW': '韩元 [韩国 ₩]', 'CHF': '法郎 [瑞士 Fr]', 'AUD': '澳元 [澳大利亚 A$]', 'IDR': '印尼盾 [印尼 Rp]', 'THB': '泰铢 [泰国 ฿]', 'PKR': '卢比 [巴基斯坦 Rs]', 'CAD': '加元 [加拿大 C$]', 'SAR': '里亚尔 [沙特阿拉伯 SR]', 'MXN': '比索 [墨西哥 $]', 'BDT': '塔卡 [孟加拉国 ৳]', 'MYR': '林吉特 [马来西亚 RM]',
        };

        const ratesContainer = document.getElementById('rates-container');
        const updateTimeEl = document.getElementById('update-time');
        const refreshButton = document.getElementById('refresh-button');
        const notificationEl = document.getElementById('copy-notification');

        const navCurrency = document.getElementById('nav-currency');
        const navJson = document.getElementById('nav-json');
        const pageCurrency = document.getElementById('page-currency');
        const pageJson = document.getElementById('page-json');
        const jsonInput = document.getElementById('json-input');
        const jsonOutput = document.getElementById('json-output');

        let exchangeRates = {}, baseCurrencyForCalc = BASE_CURRENCY, baseAmountForCalc = DEFAULT_AMOUNT, notificationTimeout;

        function formatNumber(num) { if (num > 1000) return num.toFixed(2); if (num > 1) return num.toFixed(4); return num.toFixed(6); }
        function showNotification() { if (notificationTimeout) clearTimeout(notificationTimeout); notificationEl.classList.add('show'); notificationTimeout = setTimeout(() => notificationEl.classList.remove('show'), 2000); }
        
        function renderCurrencyRows() {
            ratesContainer.innerHTML = ''; 
            currencyOrder.forEach(code => { 
                const name = currencyNames[code]; 
                if (!name) return; 
                const rateRow = document.createElement('div'); 
                rateRow.className = 'rate-row'; 
                rateRow.dataset.currencyCode = code; 
                rateRow.innerHTML = `<span class="drag-handle" title="拖动排序"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM4 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM4 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm5 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM9 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm5 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM14 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm0-5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"></path></svg></span><span class="currency-code">${code}</span><span class="separator">|</span><input type="text" class="currency-value" data-currency="${code}" placeholder="0.00"><span class="currency-name">${name}</span>`; 
                ratesContainer.appendChild(rateRow); 
            }); 
            addInputEventListeners();
        }

        function addInputEventListeners() { 
            document.querySelectorAll('.currency-value').forEach(input => { 
                input.addEventListener('input', handleInputChange); 
                input.addEventListener('click', handleInputClick);
                input.addEventListener('keydown', handleInputKeydown);
            }); 
        }

        function handleInputClick(event) { 
            const value = event.target.value; 
            if (value && !isNaN(value)) {
                navigator.clipboard.writeText(value).then(showNotification).catch(err => console.error('复制失败:', err)); 
            }
        }

        function handleInputChange(event) {
            const input = event.target;
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                baseCurrencyForCalc = input.dataset.currency; 
                baseAmountForCalc = value;
                updateAllValues();
            }
        }

        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const expression = input.value;
                try {
                    const result = new Function('return ' + expression.replace(/[^0-9\.\+\-\*\/]/g, ''))();
                    if (typeof result === 'number' && isFinite(result)) {
                        input.value = result;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } catch (e) {
                    console.error("计算错误:", e);
                }
            }
        }
        
        async function fetchRates() {
            refreshButton.disabled = true;
            updateTimeEl.textContent = '正在更新汇率...';
            try {
                const response = await fetch('/api/rates');
                if (!response.ok) throw new Error(`服务器错误: ${response.statusText}`);
                const data = await response.json();
                if (data.result === 'success') {
                    exchangeRates = data.conversion_rates;
                    const lastUpdated = new Date(data.time_last_update_unix * 1000).toLocaleString('zh-CN');
                    updateTimeEl.innerHTML = `汇率最近更新时间: <strong>${lastUpdated}</strong>`;
                    updateAllValues();
                } else {
                    throw new Error(data['error-type'] || '获取汇率失败');
                }
            } catch (error) {
                console.error('获取汇率错误:', error);
                updateTimeEl.textContent = `获取汇率失败: ${error.message}，请稍后重试。`;
            } finally {
                refreshButton.disabled = false;
            }
        }
        
        function updateAllValues() { 
            if (Object.keys(exchangeRates).length === 0) return; 
            const baseValueInCNY = baseAmountForCalc / (exchangeRates[baseCurrencyForCalc] || 1); 
            document.querySelectorAll('.currency-value').forEach(input => { 
                const currencyCode = input.dataset.currency; 
                if (currencyCode === baseCurrencyForCalc) { 
                    if (document.activeElement !== input) { 
                        input.value = formatNumber(baseAmountForCalc); 
                    }
                    return; 
                } 
                if (exchangeRates[currencyCode]) { input.value = formatNumber(baseValueInCNY * exchangeRates[currencyCode]); } 
            }); 
        }
        
        function initSortable() { 
            new Sortable(ratesContainer, { 
                animation: 200, 
                handle: '.drag-handle', 
                ghostClass: 'sortable-ghost', 
                chosenClass: 'sortable-chosen', 
                onEnd: function (evt) { 
                    const movedItem = currencyOrder.splice(evt.oldIndex, 1)[0]; 
                    currencyOrder.splice(evt.newIndex, 0, movedItem); 
                }, 
            }); 
        }

        function switchPage(pageToShow) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(n => n.classList.remove('active'));
            if (pageToShow === 'currency') {
                pageCurrency.classList.add('active');
                navCurrency.classList.add('active');
            } else if (pageToShow === 'json') {
                pageJson.classList.add('active');
                navJson.classList.add('active');
            }
        }

        function formatJson() {
            const rawJson = jsonInput.value.trim();
            jsonOutput.classList.remove('error');
            if (!rawJson) {
                jsonOutput.textContent = '';
                return;
            }
            try {
                const parsed = JSON.parse(rawJson);
                jsonOutput.textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                jsonOutput.textContent = `JSON 格式错误:\n${e.message}`;
                jsonOutput.classList.add('error');
            }
        }

        async function init() {
            renderCurrencyRows();
            initSortable();
            await fetchRates();
            baseAmountForCalc = DEFAULT_AMOUNT;
            const baseInput = document.querySelector(`.currency-value[data-currency="${BASE_CURRENCY}"]`);
            if (baseInput) { baseInput.value = DEFAULT_AMOUNT; }
            updateAllValues();
            refreshButton.addEventListener('click', fetchRates);
            navCurrency.addEventListener('click', () => switchPage('currency'));
            navJson.addEventListener('click', () => switchPage('json'));
            jsonInput.addEventListener('input', formatJson);
            setInterval(fetchRates, 15 * 60 * 1000); 
        }

        init();
    });
</script>
</body>
</html>
